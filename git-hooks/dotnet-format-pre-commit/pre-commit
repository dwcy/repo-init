#!/bin/sh
#
# Pre-commit hook that runs dotnet format on staged .NET files
# This script detects the platform and runs the appropriate version
#

# Detect if we're on Windows
if [ "$(uname -s)" = "MINGW64_NT"* ] || [ "$(uname -s)" = "CYGWIN_NT"* ] || [ -n "$WINDIR" ]; then
    # Windows - run PowerShell version
    powershell.exe -ExecutionPolicy Bypass -File "$(dirname "$0")/pre-commit.ps1"
    exit $?
fi

# Unix/Linux version
# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if dotnet is available
if ! command -v dotnet &> /dev/null; then
    echo "${RED}Error: dotnet command not found. Please install .NET SDK.${NC}"
    exit 1
fi

# Get the list of staged .cs files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Find the solution files in the project
SOLUTION_FILES=$(find . -name "*.sln" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./bin/*" -not -path "./obj/*")

if [ -z "$SOLUTION_FILES" ]; then
    # Find project files
    PROJECT_FILES=$(find . -name "*.csproj" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./bin/*" -not -path "./obj/*")
    
    if [ -z "$PROJECT_FILES" ]; then
        echo "${RED}Error: No .csproj files found.${NC}"
        exit 1
    fi
    
    # Run dotnet format on each project
    for project in $PROJECT_FILES; do
        if ! dotnet format "$project" --verbosity quiet 2>/dev/null; then
            echo "${RED}Error: dotnet format failed on $project${NC}"
            exit 1
        fi
    done
else
    # Run dotnet format on solution files
    for solution in $SOLUTION_FILES; do
        if ! dotnet format "$solution" --verbosity quiet 2>/dev/null; then
            echo "${RED}Error: dotnet format failed on $solution${NC}"
            exit 1
        fi
    done
fi

# Check if any files were modified by formatting
MODIFIED_FILES=$(git diff --name-only)
if [ ! -z "$MODIFIED_FILES" ]; then
    echo "${RED}Error: Files were modified by dotnet format. Please stage the changes:${NC}"
    echo "$MODIFIED_FILES"
    echo ""
    echo "Run 'git add .' to stage the formatted changes, or 'git commit --no-verify' to skip this check."
    exit 1
fi

exit 0
